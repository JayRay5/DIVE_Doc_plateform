name: CI/CD Pipeline - Test, Build & Deploy

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# Variables globales pour le registre d'images
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ====================================================
  # JOB 1 : TES TESTS EXISTANTS
  # ====================================================
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Installation CPU pour aller vite en test
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt

    - name: Security Scan with Bandit
      run: bandit -r src/ -ll -ii

    - name: Run Unit Tests 
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }} 
      run: pytest -v -m "not slow"

    - name: Smoke Test Backend (API)
      env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }} 
      run: |
        echo "API check..."
        nohup uvicorn src.main:app --host 127.0.0.1 --port 8000 &
        BACKEND_PID=$!
        sleep 5
        echo "Check if API is running..."
        retries=0
        max_retries=24
        until curl --output /dev/null --silent --head --fail http://127.0.0.1:8000/docs; do
            printf '.'
            retries=$((retries+1))
            if [ $retries -ge $max_retries ]; then
                echo "TIMEOUT : API has not started."
                cat backend.log
                kill $BACKEND_PID
                exit 1
            fi
            sleep 5
        done
        echo "API OK !"
        kill $BACKEND_PID

    - name: Smoke Test Frontend (Gradio)
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }} 
      run: |
        echo "Check gradio web interface..."
        python app.py > frontend.log 2>&1 &
        FRONTEND_PID=$!
        sleep 15
        if kill -0 $FRONTEND_PID 2>/dev/null; then
          echo "Gradio OK !"
          kill $FRONTEND_PID
        else
          echo "Gradio has crashed !"
          cat frontend.log
          exit 1
        fi

  # ====================================================
  # JOB 2 : BUILD DOCKER (Nouveau)
  # ====================================================
  build-and-push:
    needs: test  # SÃ©curitÃ© : On attend que les tests soient verts
    # On ne dÃ©ploie que si c'est un push sur main (pas sur les Pull Requests)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Permission d'Ã©crire dans le registre GitHub

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ====================================================
  # JOB 3 : DEPLOY TO HUGGING FACE (Nouveau)
  # ====================================================
  deploy-to-hf:
    needs: build-and-push # SÃ©curitÃ© : On attend que l'image soit prÃªte
    runs-on: ubuntu-latest
    steps:
      - name: Update HF Space Dockerfile
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          # ðŸ‘‡âš ï¸ REMPLACE PAR TES INFOS ICI âš ï¸ðŸ‘‡
          HF_USERNAME: JayRay5
          SPACE_NAME: DIVE-Doc-docvqa
          # ðŸ‘†--------------------------------ðŸ‘†
          DOCKER_IMAGE: ghcr.io/${{ github.repository }}:latest
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "GitHub Action Bot"
          
          # Clone le repo du Space
          git clone https://oauth2:$HF_TOKEN@huggingface.co/spaces/$HF_USERNAME/$SPACE_NAME space_repo
          cd space_repo
          
          # Force le Dockerfile Ã  utiliser l'image GitHub
          echo "FROM $DOCKER_IMAGE" > Dockerfile
          
          # Push vers HF
          git add Dockerfile
          git commit -m "Deploy: Update image from GitHub Actions" --allow-empty
          git push --force
